"use strict";var CustomObjectMgr=require("dw/object/CustomObjectMgr"),Transaction=require("dw/system/Transaction"),System=require("dw/system/System");function notifyEmail(t,e,s,i){var o=require("dw/net/Mail"),c=require("dw/util/Template"),a=new o,r=new o,m=new c("licensevalidationemail"),u=System.getPreferences().getCustom().OSFLicenseFrom;if(!empty(t)){var n=m.render(t);r.setFrom(u).addTo("osfproducts.support@osf-commerce.com").setSubject(s).setContent(n).send()}if(!empty(e)){var l=m.render(e);a.setFrom(u).addTo(i).setSubject(s).setContent(l).send()}}function getOSFLicenserEmails(){for(var t=[],e=CustomObjectMgr.getAllCustomObjects("OSFLicenserEmails");e.hasNext();){var s=e.next();t.push({productName:s.custom.productName,activationKey:s.custom.activationkey,email:s.custom.email,expiryDate:s.custom.expiryDate,siteID:s.custom.siteID,action:s.custom.action,hostName:s.custom.hostName})}return t}function onlyUnique(t,e,s){return s.indexOf(t)===e}function clearCustomObject(){for(var t=CustomObjectMgr.getAllCustomObjects("OSFLicenserEmails");t.hasNext();){var e=t.next();Transaction.wrap(function(){CustomObjectMgr.remove(e)})}}exports.SendEmails=function(){var t=require("dw/util/HashMap"),e=require("dw/util/ArrayList"),s=getOSFLicenserEmails(),i=[];for(var o in s){var c=s[o];i.push(c.email)}var a=i.filter(onlyUnique);if(!empty(s))for(var r in a){var m=a[r],u=new t,n=new t,l=new e,d=new e;for(var p in s){var v=s[p];v.email===m&&("servicefail"!==v.action&&d.push(v),l.push(v))}l.length&&u.put("licenses",l),d.length&&n.put("licenses",d),notifyEmail(u,n,"OSF Licenses Status",m),u.clear(),n.clear()}clearCustomObject()},exports.ValidateLicenses=function(){for(var t=require("~/cartridge/scripts/utils/licenseConstants"),e=require("~/cartridge/scripts/utils/licenseService"),s=CustomObjectMgr.getAllCustomObjects(t.CUSTOM_OBJECT_TYPE),i=require("dw/system/Site").current,o=System.instanceType===System.PRODUCTION_SYSTEM,c=new Date;s.hasNext();){var a=s.next(),r=a.custom.productCode+i.httpsHostName+i.ID;a.custom.pcID===r?e.verifyLicenseValidity(a):o&&i.ID===a.custom.siteID?(Transaction.wrap(function(){a.custom.licenseUniqueID=r}),e.verifyLicenseValidity(a)):Transaction.wrap(function(){a.custom.validationDateKey=c.getTime(),a.custom.isValid=!1});var m=a.custom.expiryDate,u=t.TIMESPAN.DAY;if(!empty(m)&&m!==t.EXPIRY_DATE.NONE){var n=m.split("-"),l=Number(n[0]),d=Number(n[1])-1,p=Number(n[2].split(" ")[0]),v=new Date(l,d,p),y=Math.round((v.getTime()-c.getTime())/u);!a.custom.isValid||30!==y&&5!==y||Transaction.wrap(function(){var t=CustomObjectMgr.createCustomObject("OSFLicenserEmails",a.custom.activationKey);t.custom.email=a.custom.email,t.custom.productName=a.custom.productName,t.custom.siteID=a.custom.siteID,t.custom.expiryDate=y.toFixed(0),t.custom.isValid=a.custom.isValid,t.custom.action="expire",t.custom.hostName=i.httpsHostName}),y<0&&Transaction.wrap(function(){a.custom.validationDateKey=c.getTime(),a.custom.isValid=!1,a.custom.gracePeriod=0})}if(!0!==a.custom.isValid){var f=null;try{f=a.custom.gracePeriod,f=!0}catch(t){f=!1}f?Transaction.wrap(function(){if(null===a.custom.gracePeriod){a.custom.gracePeriod=3,a.custom.isValid=!0;var t=CustomObjectMgr.createCustomObject("OSFLicenserEmails",a.custom.activationKey);t.custom.email=a.custom.email,t.custom.productName=a.custom.productName,t.custom.siteID=a.custom.siteID,t.custom.expiryDate=a.custom.expiryDate,t.custom.isValid=a.custom.isValid,t.custom.action="notvalidgrace",t.custom.hostName=i.httpsHostName}else if(0===a.custom.gracePeriod){a.custom.isValid=!1,a.custom.gracePeriod=0;var e=CustomObjectMgr.createCustomObject("OSFLicenserEmails",a.custom.activationKey);e.custom.email=a.custom.email,e.custom.productName=a.custom.productName,e.custom.siteID=a.custom.siteID,e.custom.expiryDate=a.custom.expiryDate,e.custom.isValid=a.custom.isValid,e.custom.action="notvalid",e.custom.hostName=i.httpsHostName}else--a.custom.gracePeriod,a.custom.isValid=!0}):Transaction.wrap(function(){var t=CustomObjectMgr.createCustomObject("OSFLicenserEmails",a.custom.activationKey);t.custom.email=a.custom.email,t.custom.productName=a.custom.productName,t.custom.siteID=a.custom.siteID,t.custom.expiryDate=a.custom.expiryDate,t.custom.isValid=a.custom.isValid,t.custom.action="notvalid",t.custom.hostName=i.httpsHostName})}else Transaction.wrap(function(){a.custom.gracePeriod=null})}};